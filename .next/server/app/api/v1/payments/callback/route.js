(()=>{var e={};e.id=9449,e.ids=[9449],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11997:e=>{"use strict";e.exports=require("punycode")},12412:e=>{"use strict";e.exports=require("assert")},17134:(e,r,t)=>{"use strict";t.r(r),t.d(r,{patchFetch:()=>h,routeModule:()=>m,serverHooks:()=>y,workAsyncStorage:()=>p,workUnitAsyncStorage:()=>l});var s={};t.r(s),t.d(s,{POST:()=>d});var a=t(96559),n=t(48088),o=t(37719),i=t(32190),c=t(42110),u=t(41506);async function d(e){try{let r=await e.json();console.log("Payment callback received:",r);let{merchantOrderId:t,amount:s,resultCode:a,merchantUserInfo:n,reference:o,signature:d}=r;if(!(0,c.oD)(r))return console.error("Invalid callback signature"),i.NextResponse.json({error:"Invalid signature"},{status:400});let{data:m,error:p}=await u.E2.from("transactions").select(`
        *,
        donor:users!transactions_user_id_fkey(id, username, full_name),
        recipient:users!transactions_recipient_id_fkey(id, username, full_name)
      `).eq("merchant_order_id",t).single();if(p||!m)return console.error("Transaction not found:",p),i.NextResponse.json({error:"Transaction not found"},{status:404});let l="failed";"00"===a?l="completed":"01"===a&&(l="pending");let{error:y}=await u.E2.from("transactions").update({status:l,payment_reference:o,completed_at:"completed"===l?new Date().toISOString():null,updated_at:new Date().toISOString()}).eq("id",m.id);if(y)return console.error("Error updating transaction:",y),i.NextResponse.json({error:"Failed to update transaction"},{status:500});if("completed"===l&&"donation"===m.type)try{let e={id:m.id,donorName:m.donor?.full_name||"Anonymous",amount:m.amount,message:m.message||"",timestamp:new Date().toISOString(),creatorId:m.recipient_id,creatorUsername:m.recipient?.username||"",isAnonymous:m.is_anonymous||!1,currency:"IDR"};global.wsServer&&(global.wsServer.emit("donation-notification",e),console.log("Donation notification sent:",e)),await Promise.all([u.E2.rpc("update_user_balance",{user_id:m.recipient_id,amount_change:m.amount-(m.fee||0)}),u.E2.rpc("update_user_earnings",{user_id:m.recipient_id,amount_change:m.amount}),u.E2.rpc("update_user_donations",{user_id:m.user_id,amount_change:m.amount})]),await u.E2.from("notifications").insert({user_id:m.recipient_id,type:"donation_received",title:"New Donation Received!",message:`You received ${new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR"}).format(m.amount)} from ${m.is_anonymous?"Anonymous":m.donor?.full_name}`,data:{donationId:m.id,amount:m.amount,donorName:m.is_anonymous?"Anonymous":m.donor?.full_name},created_at:new Date().toISOString()})}catch(e){console.error("Error sending donation notification:",e)}return console.log(`Transaction ${t} updated to ${l}`),i.NextResponse.json({success:!0,message:"Callback processed successfully",data:{merchantOrderId:t,status:l,amount:s}})}catch(e){return console.error("Payment callback error:",e),i.NextResponse.json({error:"Internal server error"},{status:500})}}let m=new a.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/v1/payments/callback/route",pathname:"/api/v1/payments/callback",filename:"route",bundlePath:"app/api/v1/payments/callback/route"},resolvedPagePath:"/Users/erico/socialbuzz/my-socialbuzz-clone/app/api/v1/payments/callback/route.ts",nextConfigOutput:"",userland:s}),{workAsyncStorage:p,workUnitAsyncStorage:l,serverHooks:y}=m;function h(){return(0,o.patchFetch)({workAsyncStorage:p,workUnitAsyncStorage:l})}},21820:e=>{"use strict";e.exports=require("os")},27910:e=>{"use strict";e.exports=require("stream")},28354:e=>{"use strict";e.exports=require("util")},29021:e=>{"use strict";e.exports=require("fs")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},33873:e=>{"use strict";e.exports=require("path")},34072:e=>{function r(e,r,t,s){return Math.round(e/t)+" "+s+(r>=1.5*t?"s":"")}e.exports=function(e,t){t=t||{};var s,a,n,o,i=typeof e;if("string"===i&&e.length>0){var c=e;if(!((c=String(c)).length>100)){var u=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(c);if(u){var d=parseFloat(u[1]);switch((u[2]||"ms").toLowerCase()){case"years":case"year":case"yrs":case"yr":case"y":return 315576e5*d;case"weeks":case"week":case"w":return 6048e5*d;case"days":case"day":case"d":return 864e5*d;case"hours":case"hour":case"hrs":case"hr":case"h":return 36e5*d;case"minutes":case"minute":case"mins":case"min":case"m":return 6e4*d;case"seconds":case"second":case"secs":case"sec":case"s":return 1e3*d;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return d;default:break}}}return}if("number"===i&&isFinite(e)){return t.long?(a=Math.abs(s=e))>=864e5?r(s,a,864e5,"day"):a>=36e5?r(s,a,36e5,"hour"):a>=6e4?r(s,a,6e4,"minute"):a>=1e3?r(s,a,1e3,"second"):s+" ms":(o=Math.abs(n=e))>=864e5?Math.round(n/864e5)+"d":o>=36e5?Math.round(n/36e5)+"h":o>=6e4?Math.round(n/6e4)+"m":o>=1e3?Math.round(n/1e3)+"s":n+"ms"}throw Error("val is not a non-empty string or a valid number. val="+JSON.stringify(e))}},34631:e=>{"use strict";e.exports=require("tls")},39727:()=>{},41506:(e,r,t)=>{"use strict";t.d(r,{E2:()=>o,ND:()=>n});var s=t(66437);let a="https://swhkbukgkafoqyvljmrd.supabase.co",n=(0,s.UU)(a,"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN3aGtidWtna2Fmb3F5dmxqbXJkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIyMDU1NzIsImV4cCI6MjA2Nzc4MTU3Mn0.kd0xWVLhcS0Ywog6-6CwmS4PRgz4hkyNibZGUSSRMRE"),o=(0,s.UU)(a,process.env.SUPABASE_SERVICE_ROLE_KEY)},42110:(e,r,t)=>{"use strict";t.d(r,{aN:()=>m,jo:()=>l,nM:()=>y,oD:()=>p});var s=t(55511),a=t.n(s),n=t(94612);let o=process.env.DUITKU_MERCHANT_CODE,i=process.env.DUITKU_API_KEY,c=process.env.DUITKU_BASE_URL||"https://sandbox.duitku.com/webapi/api",u=(e,r,t,s)=>a().createHash("md5").update(e+r+t+s).digest("hex"),d=(e,r,t,s,n)=>a().createHash("md5").update(e+r+t+s).digest("hex")===n,m=async e=>{try{let r=u(o,e.merchantOrderId,e.paymentAmount,i),t={merchantCode:o,paymentAmount:e.paymentAmount,paymentMethod:e.paymentMethod,merchantOrderId:e.merchantOrderId,productDetails:e.productDetails,customerEmail:e.customerEmail,customerName:e.customerName,customerPhone:e.customerPhone,callbackUrl:e.callbackUrl,returnUrl:e.returnUrl,signature:r,expiryPeriod:e.expiryPeriod||1440};return(await n.A.post(`${c}/merchant/createinvoice`,t,{headers:{"Content-Type":"application/json"}})).data}catch(e){throw console.error("Duitku payment request error:",e),Error("Failed to create payment request")}},p=e=>{let r=d(e.merchantCode,e.amount,e.merchantOrderId,i,e.signature),t=e.amount>0,s=e.merchantCode===o,a=["00","01"].includes(e.resultCode);return r&&t&&s&&a},l=e=>"00"===e.resultCode,y=(e,r)=>{let t=r||Date.now();return`SB-${e}-${t}`}},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},47990:()=>{},55511:e=>{"use strict";e.exports=require("crypto")},55591:e=>{"use strict";e.exports=require("https")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},74075:e=>{"use strict";e.exports=require("zlib")},78335:()=>{},79428:e=>{"use strict";e.exports=require("buffer")},79551:e=>{"use strict";e.exports=require("url")},81630:e=>{"use strict";e.exports=require("http")},83997:e=>{"use strict";e.exports=require("tty")},91645:e=>{"use strict";e.exports=require("net")},94735:e=>{"use strict";e.exports=require("events")},96487:()=>{}};var r=require("../../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),s=r.X(0,[4447,580,6437,4612],()=>t(17134));module.exports=s})();